# RSRS市场状态识别算法说明

## 什么是RSRS？

RSRS（Resistance Support Relative Strength，阻力支撑相对强度）是一种基于线性回归的技术指标，用于判断市场的牛熊状态。

## 算法原理

### 1. 核心思想

RSRS认为：**市场的最高价和最低价之间存在线性关系**。

在牛市中，市场上涨时，最高价和最低价都会上升，但最高价上升得更快，导致斜率β > 1。
在熊市中，市场下跌时，最高价和最低价都会下降，但最低价下降得更快，导致斜率β < 1。

### 2. 计算步骤

#### 步骤1：获取大盘指数数据

使用**中证1000指数（CSI1000）**作为全市场代表：
- 中证1000覆盖了A股市场1000只中小盘股票
- 更能反映市场整体情绪和资金流向
- 数据来源：通过akshare接口获取，存储到`market_index_daily`表

**降级策略**：如果指数表没有数据，则实时计算所有活跃肥羊的加权平均指数（成交额加权）。

#### 步骤2：OLS线性回归

对过去**N=18日**的大盘指数数据进行线性回归：

```
High = α + β × Low
```

其中：
- `High`: 每日最高价序列
- `Low`: 每日最低价序列
- `β`: 回归斜率（核心指标）
- `α`: 回归截距

**技术实现**：使用`statsmodels.api.OLS`进行最小二乘法回归。

#### 步骤3：计算RSRS标准分

为了消除β的绝对值影响，需要计算标准分（Z-score）：

```
RSRS_Zscore = (β - β_mean) / β_std
```

其中：
- `β_mean`: 历史β序列的均值
- `β_std`: 历史β序列的标准差

**历史β序列计算**：
- 使用滚动窗口方法，计算过去30个窗口的β值
- 每个窗口都是18日的回归结果
- 性能优化：只计算最近30个窗口，避免过多计算

#### 步骤4：判断市场状态

根据RSRS标准分判断市场状态：

| RSRS_Zscore | 市场状态 | 策略 |
|------------|---------|------|
| > 0.7 | **Attack (进攻)** | 牛市，动量跟踪，放宽风控 |
| < -0.7 | **Defense (防守)** | 熊市，均值回归，严控回撤 |
| -0.7 ~ 0.7 | **Balance (震荡)** | 震荡市，高抛低吸 |

## 为什么用中证1000？

1. **覆盖面广**：1000只股票，覆盖A股大部分市值
2. **敏感度高**：中小盘股票对市场情绪更敏感
3. **代表性强**：能更好地反映市场整体趋势
4. **数据稳定**：指数数据稳定可靠，不易被单只股票影响

## 实际应用

### 在T6模型中的应用

1. **Level 1之前执行**：在特征提取之前，先判断市场状态
2. **影响Level 2过滤**：
   - 进攻模式：放宽涨幅限制（3%~9%），优先共振肥羊
   - 防守模式：禁止追高（涨幅≤4%），低吸策略
   - 震荡模式：使用默认阈值（涨幅≥7%）
3. **影响Level 3打分**：
   - 进攻模式：奖励高Beta（科创板/创业板）
   - 防守模式：惩罚高波动

### 示例

假设当前RSRS_Zscore = 0.85：

1. **市场状态**：Attack（进攻）
2. **策略调整**：
   - 允许追高：涨幅3%~9%的肥羊都可以考虑
   - 优先选择：板块共振肥羊或RPS>85的强势肥羊
   - Beta奖励：科创板/创业板获得额外加分
3. **预期效果**：在牛市中捕捉更多上涨机会

## 数据采集

### 自动采集

指数数据通过定时任务自动采集：
- **执行时间**：每个交易日15:00（与肥羊数据采集同步）
- **采集范围**：自动补全缺失数据，首次采集最近3年
- **更新频率**：每日更新最新数据

### 手动采集

如果需要手动更新指数数据：

```python
from services.data_collection_service import DataCollectionService

service = DataCollectionService()
service.collect_index_data(index_code='CSI1000')
```

## 性能优化

1. **缓存历史β序列**：避免重复计算
2. **限制窗口数量**：只计算最近30个窗口
3. **降级策略**：指数表无数据时，实时计算加权平均
4. **提前退出**：数据不足时使用简化方法

## 注意事项

1. **数据依赖**：需要至少18天的指数数据才能计算RSRS
2. **数据质量**：指数数据质量直接影响判断准确性
3. **市场环境**：极端市场环境下，RSRS可能失效
4. **结合其他指标**：建议结合板块共振、量价结构等指标综合判断

## 参考文献

RSRS算法参考了量化交易中的技术分析理论，结合了线性回归和标准分统计方法，用于识别市场趋势和状态。
