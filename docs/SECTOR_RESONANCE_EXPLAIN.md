# 板块共振功能说明

## 功能概述

板块共振是T6模型的核心功能之一，用于识别"板块合力"，避免选出"孤立上涨"的肥羊。

## 工作原理

### 1. 自动计算（无需手动开启）

板块共振在 `Level 1` 特征提取阶段**自动计算**，不依赖 `sector_boost` 参数。

计算流程：
1. 基于 `industry` 字段，计算每个板块当日的：
   - `Sector_Avg_Chg`: 板块内肥羊平均涨跌幅
   - `Sector_Breadth`: 板块内 `change_pct > 3%` 的肥羊占比
   - `Sector_Max_Chg`: 板块内涨幅最大的肥羊（寻找领头羊）

2. 共振判定（向量化计算）：
   - **主线确认**：`Sector_Avg_Chg > 1.5%` 且 `Sector_Breadth > 20%` → 加40分
   - **孤军深入惩罚**：若肥羊 `change_pct > 6%` 但所属板块 `Sector_Avg_Chg < 0.5%` → 扣50分
   - **同伴验证**：若同板块中有肥羊涨停（`Sector_Max_Chg > 9.8%`），给予同板块其他跟风肥羊 → 加30分

### 2. sector_boost 参数的作用

`sector_boost` 参数控制**是否在评分中使用板块共振分数**：

- **sector_boost = true（默认）**：
  - 板块共振分数会通过 `w_hot` 权重（默认0.2）计入总分
  - 在进攻模式下，优先选择共振肥羊
  - 公式：`总分 = w_tech * 爆发力 + w_trend * 结构美感 + w_hot * 板块共振`

- **sector_boost = false**：
  - 板块共振分数不计入总分（设为0）
  - 不进行共振优先筛选
  - 但板块共振计算仍然执行（用于显示）

### 3. 在评分中的影响

板块共振分数通过 `w_hot` 权重影响最终得分：

```python
总分 = w_tech * 爆发力 + w_trend * 结构美感 + w_hot * 板块共振
```

其中：
- `w_hot` 默认值为 0.2（20%权重）
- 板块共振分数范围：-50 ~ +70
  - 主线板块：+40分
  - 同伴验证：+30分
  - 孤军深入：-50分

**实际影响**：
- 主线板块肥羊：总分增加约 8分（40 * 0.2）
- 孤军深入肥羊：总分减少约 10分（-50 * 0.2）

### 4. 在过滤中的影响

#### 进攻模式（Attack）

如果 `sector_boost = true`，会优先选择：
- 板块共振分数 > 0 的肥羊，或
- RPS > 85 的强势肥羊

这样可以确保在牛市中优先选择有板块支撑的肥羊。

#### 防守模式和震荡模式

板块共振不影响过滤，只影响评分。

## 如何验证板块共振是否生效

### 方法1：查看日志

运行推荐时，查看后端日志：

```
板块共振计算完成：
  - 主线板块: X 个
  - 共振加分肥羊: Y 只
  - 孤军深入扣分: Z 只
  - 共振分数范围: -50 ~ 70

Level 3: 板块共振启用，共振加分 Y 只，孤军深入扣分 Z 只
```

### 方法2：查看前端显示

在推荐结果中查看：
- **板块**列：显示所属板块
- **共振分**列：显示板块共振分数
  - 正数（绿色）：有板块支撑
  - 负数（红色）：孤军深入
  - 0：中性

### 方法3：对比测试

1. 设置 `sector_boost = true`，运行推荐
2. 设置 `sector_boost = false`，运行推荐
3. 对比结果差异

## 常见问题

### Q1: 为什么板块共振分数都是0？

**可能原因**：
1. 数据中没有 `industry` 字段（所有肥羊标记为"未知板块"）
2. 当日没有形成板块共振（没有主线板块）
3. 所有肥羊都是孤军深入（会被扣分）

**解决方法**：
- 检查数据库中的 `sheep_basic.industry` 字段是否有数据
- 查看日志中的板块共振统计信息

### Q2: 板块共振分数如何影响最终排名？

板块共振分数通过 `w_hot` 权重（默认0.2）计入总分：
- 主线板块：总分 +8分（40 * 0.2）
- 同伴验证：总分 +6分（30 * 0.2）
- 孤军深入：总分 -10分（-50 * 0.2）

### Q3: 如何调整板块共振的影响？

1. **调整权重**：修改 `w_hot` 参数（默认0.2）
   - 增大权重：板块共振影响更大
   - 减小权重：板块共振影响更小

2. **开关控制**：设置 `sector_boost = false`
   - 完全禁用板块共振在评分中的作用
   - 但计算仍然执行（用于显示）

### Q4: 板块共振计算需要什么数据？

必需字段：
- `industry`: 板块/行业字段（来自 `sheep_basic` 表）
- `change_pct`: 涨跌幅（来自 `sheep_daily` 表）

如果缺少这些字段，板块共振会降级为0分。

## 技术实现

### 向量化计算

板块共振使用完全向量化的pandas操作，性能高效：

```python
# 板块平均涨跌幅
df['sector_avg_chg'] = df.groupby('industry')['change_pct'].transform('mean')

# 板块广度
df['is_strong'] = (df['change_pct'] > 3.0).astype(int)
df['sector_breadth'] = df.groupby('industry')['is_strong'].transform('sum') / df.groupby('industry')['change_pct'].transform('count')

# 板块最大涨幅
df['sector_max_chg'] = df.groupby('industry')['change_pct'].transform('max')
```

### 性能特点

- 完全向量化，无循环
- 单次计算所有肥羊的板块共振分数
- 计算时间：< 1秒（5000只肥羊）

## 总结

板块共振是T6模型的核心功能，**自动计算，无需手动开启**。`sector_boost` 参数只控制是否在评分中使用板块共振分数。建议保持 `sector_boost = true`，以获得更好的选股效果。
