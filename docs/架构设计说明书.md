# 肥羊数据分析系统 - 架构设计说明书

**版本**: v3.0.0  
**日期**: 2026-01-16  
**作者**: 系统架构组

---

## 目录

1. [系统概述](#1-系统概述)
2. [技术架构](#2-技术架构)
3. [数据库设计](#3-数据库设计)
4. [代码结构说明](#4-代码结构说明)
5. [核心算法说明](#5-核心算法说明)
6. [前后端接口规范](#6-前后端接口规范)
7. [部署架构](#7-部署架构)

---

## 1. 系统概述

### 1.1 系统简介

肥羊数据分析系统是一个基于 FastAPI + React 的肥羊数据采集、分析和可视化系统，支持肥羊搜索、热度榜、板块分析、资金流向、AI智能推荐等功能。

### 1.2 核心功能模块

- **数据采集模块**: 自动采集肥羊日K数据、资金流向、热度榜、概念板块等数据
- **数据分析模块**: 提供肥羊深度分析、板块分析、资金流分析等功能
- **智能推荐模块**: 基于T7/T8模型的智能选股推荐系统
- **用户管理模块**: 用户认证、权限管理、用户数据隔离
- **AI分析模块**: 集成多AI模型，提供智能分析和推荐

### 1.3 技术栈

**后端**:
- FastAPI 0.104.1 (Web框架)
- MySQL 8.0 (数据库)
- SQLAlchemy 2.0 (ORM)
- APScheduler 3.10 (定时任务)
- pandas, numpy, statsmodels, scipy (量化分析)

**前端**:
- React 18.2 + TypeScript
- Vite 5.0 (构建工具)
- Ant Design 5.11 (UI组件库)
- ECharts 5.4 (图表库)

---

## 2. 技术架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                     前端层 (React)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │  Tab1    │  │  Tab2    │  │  ModelK  │  │ Settings │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────┘
                          │
                          │ HTTP/REST API
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    API层 (FastAPI)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │  认证API  │  │  肥羊API  │  │  模型API  │  │  管理API  │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────┘
                          │
                          │ 调用
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  Service层 (业务逻辑)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │SheepService│ │HotRankSvc│ │AlphaModel │ │AIService │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────┘
                          │
                          │ 调用
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  Repository层 (数据访问)                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │SheepRepo │ │MoneyFlow │ │ConceptRepo│ │HotRankRepo│ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────┘
                          │
                          │ SQL
                          ▼
┌─────────────────────────────────────────────────────────┐
│                   数据库层 (MySQL)                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │sheep_daily│ │money_flow│ │concept_* │ │hot_rank  │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 2.2 分层架构说明

#### 2.2.1 API层 (`backend/api/`)
- **职责**: 处理HTTP请求，参数验证，响应格式化
- **特点**: 无业务逻辑，仅做请求转发和响应处理
- **主要文件**: `main.py`

#### 2.2.2 Service层 (`backend/services/`)
- **职责**: 实现业务逻辑，协调Repository层和ETL层
- **特点**: 包含核心业务算法和数据处理逻辑
- **主要服务**:
  - `sheep_service.py`: 肥羊相关业务
  - `hot_rank_service.py`: 热度榜业务
  - `concept_service.py`: 概念板块业务
  - `alpha_model_t7_concept_flow.py`: T7模型算法
  - `alpha_model_t8_anti_chase.py`: T8模型算法
  - `backtest_engine.py`: 回测引擎
  - `ai_service.py`: AI分析服务
  - `data_collection_service.py`: 数据采集服务

#### 2.2.3 Repository层 (`backend/db/`)
- **职责**: 数据库CRUD操作，SQL语句封装
- **特点**: 与数据库表一一对应，提供统一的数据访问接口
- **主要Repository**:
  - `sheep_repository.py`: 肥羊数据访问
  - `money_flow_repository.py`: 资金流数据访问
  - `concept_repository.py`: 概念数据访问
  - `hot_rank_repository.py`: 热度榜数据访问
  - `strategy_recommendation_repository.py`: 推荐记录访问

#### 2.2.4 ETL层 (`backend/etl/`)
- **职责**: 数据采集适配器，封装外部数据源接口
- **特点**: 与数据源解耦，便于切换数据源
- **主要适配器**:
  - `sheep_adapter.py`: 肥羊数据采集
  - `concept_adapter.py`: 概念数据采集
  - `hot_rank_adapter.py`: 热度榜数据采集
  - `trade_date_adapter.py`: 交易日判断

---

## 3. 数据库设计

### 3.1 数据库概述

- **数据库名**: `stock`
- **字符集**: `utf8mb4`
- **存储引擎**: `InnoDB`
- **表命名规范**: 使用`sheep_*`前缀（肥羊相关），其他业务表使用业务名称

### 3.2 核心数据表

#### 3.2.1 肥羊基本信息表 (`sheep_basic`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| sheep_code | VARCHAR(10) | 肥羊代码（6位数字） | PRIMARY KEY |
| sheep_name | VARCHAR(50) | 肥羊名称 | NOT NULL |
| market | VARCHAR(10) | 所属市场（SH/SZ） | |
| industry | VARCHAR(50) | 所属行业 | |
| list_date | DATE | 上市日期 | |
| is_active | TINYINT(1) | 是否有效（1=有效，0=退市） | DEFAULT 1 |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `sheep_code`
- INDEX: `idx_sheep_name`, `idx_market`, `idx_is_active`

#### 3.2.2 肥羊交易日数据表 (`sheep_daily`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| sheep_code | VARCHAR(10) | 肥羊代码 | NOT NULL |
| trade_date | DATE | 交易日期 | NOT NULL |
| open_price | DECIMAL(10,1) | 开盘价 | |
| close_price | DECIMAL(10,1) | 收盘价 | |
| high_price | DECIMAL(10,1) | 最高价 | |
| low_price | DECIMAL(10,1) | 最低价 | |
| volume | BIGINT UNSIGNED | 成交量（手） | DEFAULT 0 |
| amount | DECIMAL(20,2) | 成交额（元） | DEFAULT 0 |
| turnover_rate | DECIMAL(5,1) | 换手率（%） | |
| change_pct | DECIMAL(7,1) | 涨跌幅（%） | |
| ma5 | DECIMAL(10,1) | 5日均价 | |
| ma10 | DECIMAL(10,1) | 10日均价 | |
| ma20 | DECIMAL(10,1) | 20日均价 | |
| ma30 | DECIMAL(10,1) | 30日均价 | |
| ma60 | DECIMAL(10,1) | 60日均价 | |
| vol_ma_5 | DECIMAL(20,1) | 5日均量（倍量基准） | |
| rps_250 | DECIMAL(5,1) | 250日RPS强度 | |
| vcp_factor | DECIMAL(10,1) | 波动收敛系数（VCP） | |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_sheep_date` (`sheep_code`, `trade_date`)
- INDEX: `idx_trade_date`, `idx_sheep_code_date`, `idx_date_code`

**数据保留策略**: 保留3年（1095天），用于模型回测

#### 3.2.3 肥羊资金流向表 (`sheep_money_flow`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| sheep_code | VARCHAR(10) | 肥羊代码 | NOT NULL |
| trade_date | DATE | 交易日期 | NOT NULL |
| main_net_inflow | DECIMAL(20,2) | 主力净流入（万元） | DEFAULT 0 |
| super_large_inflow | DECIMAL(20,2) | 超大单净流入（万元） | DEFAULT 0 |
| large_inflow | DECIMAL(20,2) | 大单净流入（万元） | DEFAULT 0 |
| medium_inflow | DECIMAL(20,2) | 中单净流入（万元） | DEFAULT 0 |
| small_inflow | DECIMAL(20,2) | 小单净流入（万元） | DEFAULT 0 |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_sheep_date` (`sheep_code`, `trade_date`)
- INDEX: `idx_trade_date`, `idx_sheep_code_date`

**数据保留策略**: 保留3年（1095天）

#### 3.2.4 概念主题表 (`concept_theme`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| concept_id | INT UNSIGNED | 概念ID | PRIMARY KEY, AUTO_INCREMENT |
| concept_name | VARCHAR(100) | 概念名称 | NOT NULL |
| concept_code | VARCHAR(50) | 概念代码 | |
| source | VARCHAR(20) | 数据来源（ths=同花顺，em=东财） | DEFAULT 'ths' |
| description | TEXT | 概念描述 | |
| is_active | TINYINT(1) | 是否有效 | DEFAULT 1 |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `concept_id`
- UNIQUE KEY: `uk_concept_name_source` (`concept_name`, `source`)
- INDEX: `idx_concept_name`, `idx_is_active`

#### 3.2.5 肥羊与概念关联表 (`sheep_concept_mapping`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| sheep_code | VARCHAR(10) | 肥羊代码 | NOT NULL |
| concept_id | INT UNSIGNED | 概念ID | NOT NULL |
| weight | DECIMAL(5,2) | 关联权重（用于计算虚拟板块） | DEFAULT 1.0 |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_sheep_concept` (`sheep_code`, `concept_id`)
- INDEX: `idx_sheep_code`, `idx_concept_id`, `idx_weight`

#### 3.2.6 虚拟板块聚合表 (`virtual_board_aggregation`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| virtual_board_name | VARCHAR(100) | 虚拟板块名称 | NOT NULL |
| source_concept_name | VARCHAR(100) | 源概念名称 | NOT NULL |
| weight | DECIMAL(5,2) | 聚合权重 | DEFAULT 1.0 |
| is_active | TINYINT(1) | 是否有效 | DEFAULT 1 |
| description | TEXT | 描述 | |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_virtual_source` (`virtual_board_name`, `source_concept_name`)
- INDEX: `idx_virtual_board`, `idx_source_concept`, `idx_is_active`

#### 3.2.7 市场热度排名表 (`market_hot_rank`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| sheep_code | VARCHAR(10) | 肥羊代码 | NOT NULL |
| sheep_name | VARCHAR(50) | 肥羊名称 | NOT NULL |
| rank | INT UNSIGNED | 排名 | NOT NULL |
| source | VARCHAR(20) | 数据来源（xueqiu/dongcai/ths等） | NOT NULL |
| trade_date | DATE | 交易日期 | NOT NULL |
| hot_score | DECIMAL(10,2) | 热度分数 | |
| volume | BIGINT UNSIGNED | 成交量（手） | DEFAULT 0 |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_source_date_rank` (`source`, `trade_date`, `rank`)
- INDEX: `idx_sheep_code`, `idx_trade_date`, `idx_source_date`, `idx_rank`

**数据保留策略**: 保留30天

#### 3.2.8 板块资金流向表 (`sector_money_flow`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| sector_name | VARCHAR(100) | 板块名称 | NOT NULL |
| trade_date | DATE | 交易日期 | NOT NULL |
| main_net_inflow | DECIMAL(20,2) | 主力净流入（万元） | DEFAULT 0 |
| super_large_inflow | DECIMAL(20,2) | 超大单净流入（万元） | DEFAULT 0 |
| large_inflow | DECIMAL(20,2) | 大单净流入（万元） | DEFAULT 0 |
| medium_inflow | DECIMAL(20,2) | 中单净流入（万元） | DEFAULT 0 |
| small_inflow | DECIMAL(20,2) | 小单净流入（万元） | DEFAULT 0 |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_sector_date` (`sector_name`, `trade_date`)
- INDEX: `idx_trade_date`, `idx_sector_date`, `idx_main_inflow`

**数据保留策略**: 保留3个月（90天）

#### 3.2.9 大盘指数数据表 (`market_index_daily`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| index_code | VARCHAR(20) | 指数代码（CSI1000=中证1000） | NOT NULL, DEFAULT 'CSI1000' |
| index_name | VARCHAR(50) | 指数名称 | NOT NULL, DEFAULT '中证1000' |
| trade_date | DATE | 交易日期 | NOT NULL |
| open_price | DECIMAL(10,2) | 开盘价 | |
| close_price | DECIMAL(10,2) | 收盘价 | |
| high_price | DECIMAL(10,2) | 最高价 | |
| low_price | DECIMAL(10,2) | 最低价 | |
| volume | BIGINT UNSIGNED | 成交量 | DEFAULT 0 |
| amount | DECIMAL(20,2) | 成交额 | DEFAULT 0 |
| change_pct | DECIMAL(7,2) | 涨跌幅（%） | |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_index_date` (`index_code`, `trade_date`)
- INDEX: `idx_trade_date`, `idx_index_code_date`

**用途**: 用于RSRS市场状态识别算法

#### 3.2.10 用户表 (`users`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT UNSIGNED | 用户ID | PRIMARY KEY, AUTO_INCREMENT |
| username | VARCHAR(50) | 用户名 | NOT NULL, UNIQUE |
| password_hash | VARCHAR(255) | 密码哈希 | NOT NULL |
| is_active | TINYINT(1) | 是否激活 | DEFAULT 1 |
| can_use_ai_recommend | TINYINT(1) | 是否允许使用AI推荐功能 | DEFAULT 0 |
| failed_login_attempts | INT | 失败登录次数 | DEFAULT 0 |
| locked_until | DATETIME | 锁定截止时间 | |
| last_login | DATETIME | 最后登录时间 | |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_username` (`username`)
- INDEX: `idx_is_active`

#### 3.2.11 登录日志表 (`login_logs`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| username | VARCHAR(50) | 用户名 | NOT NULL |
| ip_address | VARCHAR(50) | IP地址 | |
| user_agent | TEXT | 用户代理 | |
| login_status | VARCHAR(20) | 登录状态（SUCCESS/FAILED） | NOT NULL |
| failure_reason | VARCHAR(255) | 失败原因 | |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_username`, `idx_created_at`

#### 3.2.12 AI配置表 (`ai_config`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| config_key | VARCHAR(50) | 配置键（api_key, prompt_recommend等） | NOT NULL, UNIQUE |
| config_value | TEXT | 配置值 | |
| description | VARCHAR(255) | 配置说明 | |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_config_key` (`config_key`)

#### 3.2.13 AI模型配置表 (`ai_model_config`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| model_name | VARCHAR(50) | 模型名称（如：gpt-4, claude-3等） | NOT NULL, UNIQUE |
| model_display_name | VARCHAR(100) | 模型显示名称 | NOT NULL |
| api_key | VARCHAR(255) | API密钥 | |
| api_url | VARCHAR(255) | API地址 | |
| sort_order | INT | 排序顺序 | DEFAULT 0 |
| is_active | TINYINT(1) | 是否启用 | DEFAULT 1 |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_model_name` (`model_name`)
- INDEX: `idx_is_active`, `idx_sort_order`

#### 3.2.14 AI分析结果缓存表 (`ai_analysis_cache`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| cache_key | VARCHAR(100) | 缓存键（sheep_code或recommend） | NOT NULL |
| cache_type | VARCHAR(20) | 缓存类型（analyze/recommend） | NOT NULL |
| content | TEXT | AI分析结果内容 | NOT NULL |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_cache_key_type` (`cache_key`, `cache_type`)
- INDEX: `idx_cache_key`, `idx_cache_type`, `idx_created_at`

**缓存策略**: 3小时有效期

#### 3.2.15 策略推荐记录表 (`strategy_recommendations`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| user_id | INT UNSIGNED | 用户ID（用于用户数据隔离） | NOT NULL, DEFAULT 0 |
| run_date | DATE | 推荐计算日期 | NOT NULL |
| strategy_version | VARCHAR(20) | 策略版本（T7_Concept_Flow/T8_Anti_Chase） | DEFAULT 'T7_Concept_Flow' |
| ts_code | VARCHAR(20) | 肥羊代码（兼容ts_code格式） | NOT NULL |
| sheep_code | VARCHAR(10) | 肥羊代码（6位数字） | NOT NULL |
| sheep_name | VARCHAR(50) | 肥羊名称 | |
| params_snapshot | JSON | 参数快照（保存当时用户设置的参数） | |
| entry_price | DECIMAL(10,1) | 推荐时价格（买入价） | |
| ai_score | DECIMAL(5,1) | 模型最终打分 | |
| win_probability | DECIMAL(5,1) | AI预测胜率 | |
| reason_tags | VARCHAR(255) | 推荐理由标签 | |
| stop_loss_price | DECIMAL(10,1) | 止损建议价 | |
| is_verified | TINYINT | 是否已验证（0=未验证，1=已验证） | DEFAULT 0 |
| max_return_5d | DECIMAL(10,1) | 后5日最大涨幅（%） | |
| final_return_5d | DECIMAL(10,1) | 后5日最终涨幅（%） | |
| final_result | VARCHAR(10) | 结果（SUCCESS/FAIL） | |
| create_time | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| update_time | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `idx_unique_rec` (`user_id`, `run_date`, `sheep_code`)
- INDEX: `idx_user_id`, `idx_run_date`, `idx_sheep_code`, `idx_ts_code`, `idx_is_verified`, `idx_final_result`

**数据保留策略**: 永久保留，用于策略复盘和优化

#### 3.2.16 肥羊财务数据表 (`sheep_financials`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| sheep_code | VARCHAR(10) | 肥羊代码 | NOT NULL |
| report_date | DATE | 报告期（季度/年度） | NOT NULL |
| rd_exp | DECIMAL(20,2) | 研发费用（元） | |
| net_profit | DECIMAL(20,2) | 净利润（元） | |
| net_profit_growth | DECIMAL(10,1) | 净利润增长率（%） | |
| total_revenue | DECIMAL(20,2) | 营业收入（元） | |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_sheep_report` (`sheep_code`, `report_date`)
- INDEX: `idx_sheep_code`, `idx_report_date`

**数据保留策略**: 保留5年

#### 3.2.17 下个交易日预测缓存表 (`next_day_prediction_cache`)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT UNSIGNED | 自增ID | PRIMARY KEY, AUTO_INCREMENT |
| target_date | DATE | 预测目标日期（下个交易日） | NOT NULL, UNIQUE |
| prediction_data | JSON | 预测结果JSON数据 | NOT NULL |
| created_at | TIMESTAMP | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_target_date` (`target_date`)
- INDEX: `idx_created_at`

**更新策略**: 每半小时更新，保留7天

### 3.3 数据库关系图

```
sheep_basic (1) ──┐
                  │
                  ├──> (1:N) sheep_daily
                  │
                  ├──> (1:N) sheep_money_flow
                  │
                  └──> (N:M) sheep_concept_mapping ──> (N:1) concept_theme

concept_theme (1) ──> (N:1) virtual_board_aggregation

users (1) ──> (1:N) strategy_recommendations
```

---

## 4. 代码结构说明

### 4.1 后端代码结构

```
backend/
├── api/                          # API层
│   ├── __init__.py
│   └── main.py                   # FastAPI主应用，所有API端点定义
│
├── auth/                         # 认证模块
│   ├── auth.py                   # JWT认证逻辑，用户认证
│   └── init_admin.py             # 初始化管理员用户
│
├── db/                           # Repository层（数据访问层）
│   ├── __init__.py
│   ├── database.py               # 数据库连接管理，连接池配置
│   ├── sheep_repository.py       # 肥羊数据CRUD操作
│   ├── money_flow_repository.py  # 资金流数据CRUD操作
│   ├── sector_money_flow_repository.py  # 板块资金流数据CRUD操作
│   ├── concept_repository.py     # 概念数据CRUD操作
│   ├── hot_rank_repository.py    # 热度榜数据CRUD操作
│   ├── index_repository.py       # 指数数据CRUD操作
│   ├── ai_config_repository.py   # AI配置CRUD操作
│   ├── ai_model_config_repository.py  # AI模型配置CRUD操作
│   ├── ai_cache_repository.py    # AI缓存CRUD操作
│   ├── strategy_recommendation_repository.py  # 推荐记录CRUD操作

│   └── financial_repository.py   # 财务数据CRUD操作
│
├── etl/                          # ETL层（数据采集适配器）
│   ├── __init__.py
│   ├── trade_date_adapter.py     # 交易日判断，交易日计算
│   ├── sheep_adapter.py          # 肥羊数据采集（akshare封装）
│   ├── concept_adapter.py        # 概念数据采集（akshare封装）
│   ├── concept_filter.py         # 概念过滤逻辑
│   ├── hot_rank_adapter.py       # 热度榜数据采集（akshare封装）
│   ├── index_adapter.py          # 指数数据采集（akshare封装）
│   ├── sector_money_flow_adapter.py  # 板块资金流数据采集
│   └── financial_adapter.py      # 财务数据采集
│
├── services/                     # Service层（业务逻辑层）
│   ├── __init__.py
│   ├── data_collection_service.py  # 数据采集服务，统一调度数据采集
│   ├── sheep_service.py           # 肥羊业务服务，肥羊搜索、日K数据获取
│   ├── hot_rank_service.py        # 热度榜业务服务，热度榜获取、热门板块计算
│   ├── concept_service.py         # 概念板块业务服务，板块K线、板块肥羊
│   ├── concept_management_service.py  # 概念管理服务，概念CRUD、虚拟板块管理
│   ├── concept_money_flow_service.py  # 概念资金流服务，概念资金流计算
│   ├── sector_matching_service.py  # 板块匹配服务，虚拟板块聚合算法
│   ├── user_service.py           # 用户管理服务，用户CRUD
│   ├── ai_service.py             # AI分析服务，AI推荐和分析
│   ├── alpha_model_t7_concept_flow.py  # T7模型算法（概念资金双驱）
│   ├── alpha_model_t8_anti_chase.py   # T8模型算法（逆向低吸）
│   ├── backtest_engine.py        # 回测引擎，时光机逻辑回测
│   ├── stock_analysis_service.py  # 肥羊深度分析服务，走势预判、形态识别
│   └── next_day_prediction_service.py  # 下个交易日预测服务
│
├── config.py                     # 配置文件，环境变量配置
├── scheduler.py                  # 定时任务调度器，APScheduler配置
└── requirements.txt              # Python依赖包
```

### 4.2 前端代码结构

```
frontend/
├── src/
│   ├── api/                      # API客户端
│   │   ├── client.ts             # Axios客户端配置
│   │   ├── auth.ts               # 认证API
│   │   ├── sheep.ts              # 肥羊API
│   │   ├── hot.ts                # 热度榜API
│   │   ├── sector.ts             # 板块API
│   │   ├── modelK.ts             # 模型老K API
│   │   ├── ai.ts                 # AI API
│   │   ├── user.ts               # 用户管理API
│   │   └── dataCollection.ts     # 数据采集API
│   │
│   ├── components/               # 组件
│   │   ├── Layout.tsx            # 布局组件
│   │   ├── ProtectedRoute.tsx    # 路由保护组件
│   │   ├── KLineChart.tsx        # K线图组件
│   │   ├── SimpleKLineChart.tsx  # 简化K线图组件
│   │   └── DeepAnalysis.tsx      # 深度分析组件
│   │
│   ├── contexts/                 # Context
│   │   └── AuthContext.tsx       # 认证上下文
│   │
│   ├── pages/                    # 页面
│   │   ├── Login.tsx             # 登录页
│   │   ├── Tab1.tsx              # 肥羊分析页
│   │   ├── Tab2.tsx              # 热度榜页
│   │   ├── ModelK.tsx            # 模型老K页
│   │   ├── SettingsMain.tsx      # 设置主页
│   │   ├── Settings.tsx          # 设置页
│   │   ├── AIManagement.tsx       # AI管理页
│   │   ├── DataManagement.tsx     # 数据管理页
│   │   ├── UserManagement.tsx    # 用户管理页
│   │   └── Docs.tsx              # 文档页
│   │
│   ├── App.tsx                   # 主应用组件，路由配置
│   ├── main.tsx                  # 入口文件
│   └── index.css                 # 全局样式
│
├── package.json                  # 依赖配置
├── vite.config.ts                # Vite配置
└── tsconfig.json                 # TypeScript配置
```

### 4.3 核心类和方法说明

#### 4.3.1 AlphaModelT7ConceptFlow (T7模型)

**文件**: `backend/services/alpha_model_t7_concept_flow.py`

**核心方法**:
- `run_full_pipeline(trade_date, params, top_n)`: 执行完整推荐流程
  - 参数: `trade_date` (交易日期), `params` (策略参数), `top_n` (返回数量)
  - 返回: `(recommendations, diagnostic_info, metadata)`
  - 流程: SQL过滤 -> 特征提取 -> 精筛 -> 打分 -> 排序

- `_sql_level0_filter(trade_date, params)`: SQL层基础过滤
  - 下沉到SQL层的基础过滤（市值、RPS、ST、新股、涨停、基础均线）
  - 利用预计算字段（rps_250, vcp_factor, vol_ma_5）进行宽口径过滤

- `_calculate_concept_resonance(sheep_code, trade_date)`: 计算概念共振分数
  - 基于肥羊所属概念的资金流入和涨幅计算共振分数

- `_calculate_market_regime(trade_date)`: 计算市场状态
  - 基于RSRS和板块轮动强度判断市场状态（Attack/Defense/Balance）

- `_calculate_launch_quality(sheep_code, trade_date)`: 计算启动质量分
  - 扣分制 + 一票否决机制，识别低质量启动

#### 4.3.2 AlphaModelT8AntiChase (T8模型)

**文件**: `backend/services/alpha_model_t8_anti_chase.py`

**核心方法**:
- `run_full_pipeline(trade_date, params, top_n)`: 执行完整推荐流程
  - T8逆向低吸模型，专注提高成功率
  - 策略：寻找回调后的低吸机会

#### 4.3.3 BacktestEngine (回测引擎)

**文件**: `backend/services/backtest_engine.py`

**核心方法**:
- `run_backtest(start_date, end_date, params)`: 执行回测
  - 时光机逻辑：使用历史数据模拟交易
  - 返回：胜率、Alpha收益率、总收益率、最大回撤等指标

#### 4.3.4 DataCollectionService (数据采集服务)

**文件**: `backend/services/data_collection_service.py`

**核心方法**:
- `collect_sheep_daily_data(days=None)`: 采集肥羊日K数据
- `collect_money_flow_data(target_date=None)`: 采集资金流向数据
- `collect_concept_money_flow_data(target_date=None)`: 采集概念资金流向数据
- `collect_hot_rank_data()`: 采集热度榜数据
- `collect_concept_data()`: 采集概念板块数据
- `collect_index_data(index_code='CSI1000')`: 采集指数数据
- `collect_financial_data()`: 采集财务数据

---

## 5. 核心算法说明

### 5.1 T7概念资金双驱模型算法

#### 5.1.1 算法概述

T7模型是一个基于概念资金双驱的智能选股模型，核心思想是：
1. **概念竞速引擎**: 识别最强概念驱动力
2. **资金流验证**: 验证主力资金意图
3. **动态权重调整**: 根据市场状态调整评分权重
4. **启动质量验证**: 识别高质量启动信号

#### 5.1.2 算法流程

```
输入: trade_date, params, top_n
  │
  ├─> Level 0: SQL层基础过滤
  │     ├─> 市值过滤 (10-500亿)
  │     ├─> RPS过滤 (>=80)
  │     ├─> ST/新股/涨停过滤
  │     └─> 基础均线过滤
  │
  ├─> Level 1: 特征提取
  │     ├─> 技术指标计算 (MA, RSI, MACD等)
  │     ├─> 资金流指标计算
  │     └─> 概念关联提取
  │
  ├─> Level 2: 精筛
  │     ├─> 概念共振分数计算
  │     ├─> 资金流占比计算
  │     ├─> 启动质量分计算
  │     └─> 市场状态识别
  │
  ├─> Level 3: 打分
  │     ├─> 技术因子得分 (30%)
  │     ├─> 资金流因子得分 (25%)
  │     ├─> 概念共振得分 (25%)
  │     ├─> 市场状态调整 (20%)
  │     └─> 启动质量扣分
  │
  └─> 输出: recommendations (按ai_score排序，取top_n)
```

#### 5.1.3 核心算法公式

**1. 概念共振分数**:
```
concept_resonance_score = Σ(concept_weight × concept_money_inflow × concept_change_pct)
```
- `concept_weight`: 概念权重（虚拟板块聚合权重）
- `concept_money_inflow`: 概念资金净流入
- `concept_change_pct`: 概念涨幅

**2. 资金流占比**:
```
flow_ratio = (main_net_inflow / amount) × 100
```
- `main_net_inflow`: 主力净流入（万元）
- `amount`: 成交额（万元）

**3. 市场状态识别**:
```
market_regime = f(RSRS_score, sector_rotation_strength)
```
- `RSRS_score`: RSRS指标分数（15%权重）
- `sector_rotation_strength`: 板块轮动强度（25%权重）

**4. 启动质量分**:
```
launch_quality = base_score - penalty_points
```
- `base_score`: 基础分（0分，不送分）
- `penalty_points`: 扣分项（墓碑线、放量滞涨、主力出货等）

**5. 最终AI评分**:
```
ai_score = (tech_score × 0.30) + (flow_score × 0.25) + (concept_score × 0.25) + (market_adjust × 0.20) - launch_penalty
```

#### 5.1.4 市场状态自适应

**Attack模式（结构性牛市）**:
- 触发条件: 单一板块资金流入 > 50亿 (v6.1优化)
- 策略调整: 放宽个股技术形态要求，提升"板块共振"和"资金流"权重

**Defense模式（防守）**:
- 触发条件: RSRS < 0.5 且板块轮动强度低
- 策略调整: 提高技术形态要求，降低概念权重

**Balance模式（震荡）**:
- 触发条件: 其他情况
- 策略调整: 均衡权重

### 5.2 T8逆向低吸模型算法

#### 5.2.1 算法概述

T8模型专注于提高成功率，采用逆向低吸策略：
- 寻找回调后的低吸机会
- 关注技术形态和资金流
- 降低追高风险

#### 5.2.2 核心策略

1. **回调识别**: 识别短期回调但趋势未破的肥羊
2. **支撑位确认**: 确认关键支撑位（MA20/MA30）
3. **资金流验证**: 验证回调期间资金流情况
4. **低吸时机**: 在支撑位附近寻找低吸机会

### 5.3 RSRS市场状态识别算法

#### 5.3.1 算法原理

RSRS（阻力支撑相对强度）是一个基于线性回归的市场状态识别指标。

**计算步骤**:
1. 取最近N日（默认18日）的最高价和最低价
2. 对最高价和最低价进行线性回归: `high = α + β × low`
3. 计算RSRS分数: `RSRS = β × (current_low / avg_low)`
4. 根据RSRS分数判断市场状态:
   - RSRS > 1.0: 牛市（Bull）
   - RSRS < 0.5: 熊市（Bear）
   - 其他: 震荡（Neutral）

#### 5.3.2 实现位置

- **文件**: `backend/services/alpha_model_t7_concept_flow.py`
- **方法**: `_calculate_market_regime(trade_date)`

### 5.4 虚拟板块聚合算法

#### 5.4.1 算法概述

虚拟板块聚合算法用于将多个相关概念聚合成一个虚拟板块，便于板块分析和资金流计算。

#### 5.4.2 算法流程

```
输入: 肥羊代码 sheep_code
  │
  ├─> 获取肥羊所属的所有概念
  │
  ├─> 查找虚拟板块映射 (virtual_board_aggregation表)
  │     ├─> 找到包含该概念的虚拟板块
  │     └─> 获取聚合权重
  │
  ├─> 计算虚拟板块资金流
  │     └─> 加权聚合: Σ(concept_money_flow × weight)
  │
  └─> 输出: 虚拟板块名称和资金流
```

#### 5.4.3 实现位置

- **文件**: `backend/services/sector_matching_service.py`
- **方法**: `get_virtual_board_for_sheep(sheep_code)`

### 5.5 回测引擎算法

#### 5.5.1 时光机逻辑

回测引擎采用"时光机逻辑"，即使用历史数据模拟交易：

```
for each trading_day in [start_date, end_date]:
  1. 获取该日期的推荐列表（使用该日期之前的数据）
  2. 模拟买入（使用推荐日的收盘价）
  3. 计算持有期收益（5个交易日）
  4. 记录交易结果
```

#### 5.5.2 回测指标

- **胜率**: 成功交易数 / 总交易数
- **Alpha收益率**: 策略收益 - 基准收益（中证1000）
- **总收益率**: 累计收益率
- **最大回撤**: 最大亏损幅度

#### 5.5.3 实现位置

- **文件**: `backend/services/backtest_engine.py`
- **方法**: `run_backtest(start_date, end_date, params)`

---

## 6. 前后端接口规范

### 6.1 接口规范说明

- **协议**: HTTP/HTTPS
- **数据格式**: JSON
- **认证方式**: JWT Bearer Token
- **字符编码**: UTF-8

### 6.2 认证相关接口

#### 6.2.1 用户登录

**接口**: `POST /api/auth/login`

**请求体**:
```json
{
  "username": "admin",
  "password": "admin123"
}
```

**响应**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "username": "admin"
}
```

#### 6.2.2 获取当前用户信息

**接口**: `GET /api/auth/me`

**请求头**:
```
Authorization: Bearer {token}
```

**响应**:
```json
{
  "id": 1,
  "username": "admin",
  "is_admin": true
}
```

### 6.3 肥羊相关接口

#### 6.3.1 搜索肥羊

**接口**: `GET /api/sheep/search?q={keyword}`

**参数**:
- `q` (string): 搜索关键词（肥羊代码或名称）

**响应**:
```json
{
  "sheep": [
    {
      "sheep_code": "000001",
      "sheep_name": "平安银行",
      "market": "SZ"
    }
  ]
}
```

#### 6.3.2 获取肥羊日K数据

**接口**: `GET /api/sheep/{sheep_code}/daily`

**路径参数**:
- `sheep_code` (string): 肥羊代码（6位数字）

**请求头**:
```
Authorization: Bearer {token}
```

**响应**:
```json
{
  "data": [
    {
      "trade_date": "2026-01-15",
      "open_price": 10.5,
      "close_price": 10.8,
      "high_price": 11.0,
      "low_price": 10.3,
      "volume": 1000000,
      "amount": 10800000.0,
      "turnover_rate": 2.5,
      "change_pct": 2.8,
      "ma5": 10.6,
      "ma10": 10.4,
      "ma20": 10.2
    }
  ]
}
```

#### 6.3.3 获取资金流向数据

**接口**: `GET /api/sheep/{sheep_code}/capital-flow?days={days}`

**路径参数**:
- `sheep_code` (string): 肥羊代码

**查询参数**:
- `days` (int): 返回天数（30或60，默认60）

**响应**:
```json
{
  "data": [
    {
      "date": "2026-01-15",
      "main": 1000.5,
      "super_large": 500.2,
      "large": 300.3,
      "medium": 100.0,
      "small": -900.0
    }
  ]
}
```

### 6.4 热度榜相关接口

#### 6.4.1 获取热度榜

**接口**: `GET /api/hot-sheep?source={source}`

**查询参数**:
- `source` (string, 可选): 数据源（xueqiu/dongcai/ths）

**响应**:
```json
{
  "sheep": [
    {
      "sheep_code": "000001",
      "sheep_name": "平安银行",
      "rank": 1,
      "source": "xueqiu",
      "hot_score": 95.5,
      "current_price": 10.8,
      "change_pct": 2.8
    }
  ]
}
```

#### 6.4.2 获取热门板块

**接口**: `GET /api/hot-sectors`

**响应**:
```json
{
  "sectors": [
    {
      "sector_name": "人工智能",
      "sheep_count": 50,
      "avg_change_pct": 3.5,
      "total_money_inflow": 50000.0
    }
  ]
}
```

### 6.5 板块相关接口

#### 6.5.1 获取板块K线

**接口**: `GET /api/sectors/{sector_name}/daily`

**路径参数**:
- `sector_name` (string): 板块名称

**响应**:
```json
{
  "data": [
    {
      "trade_date": "2026-01-15",
      "open_price": 100.5,
      "close_price": 102.0,
      "high_price": 103.0,
      "low_price": 100.0,
      "change_pct": 1.5
    }
  ]
}
```

#### 6.5.2 获取板块肥羊

**接口**: `GET /api/sectors/{sector_name}/sheep`

**响应**:
```json
{
  "sheep": [
    {
      "sheep_code": "000001",
      "sheep_name": "平安银行",
      "current_price": 10.8,
      "change_pct": 2.8
    }
  ]
}
```

#### 6.5.3 获取板块资金净流入推荐

**接口**: `GET /api/sector-money-flow/recommend?days={days}&limit={limit}`

**查询参数**:
- `days` (int): 统计天数（1/3/5，默认1）
- `limit` (int): 返回数量（最大30，默认30）

**响应**:
```json
{
  "sectors": [
    {
      "sector_name": "人工智能",
      "net_inflow": 50000.0,
      "sheep_count": 50,
      "avg_change_pct": 3.5
    }
  ],
  "days": 1,
  "metadata": {
    "total_sectors": 200,
    "filtered_sectors": 30
  }
}
```

### 6.6 模型老K相关接口

#### 6.6.1 获取默认参数

**接口**: `GET /api/model-k/default-params`

**响应**:
```json
{
  "params": {
    "min_change_pct": 2.0,
    "max_change_pct": 9.5,
    "vol_threshold": 1.5,
    "rps_threshold": 80,
    "concept_boost": true,
    "ai_filter": true,
    "min_win_probability": 45,
    "min_ai_score": 50
  },
  "veto_conditions": {
    "max_change_pct": 12.0,
    "min_vol_ratio": 1.3
  },
  "version": "T7_v5.0"
}
```

#### 6.6.2 获取智能推荐

**接口**: `POST /api/model-k/recommend`

**请求体**:
```json
{
  "params": {
    "min_change_pct": 2.0,
    "max_change_pct": 9.5,
    "vol_threshold": 1.5,
    "rps_threshold": 80,
    "concept_boost": true,
    "ai_filter": true,
    "min_win_probability": 45,
    "min_ai_score": 50
  },
  "trade_date": "2026-01-15",
  "top_n": 20,
  "model_version": "T7"
}
```

**响应**:
```json
{
  "trade_date": "2026-01-15",
  "recommendations": [
    {
      "sheep_code": "000001",
      "sheep_name": "平安银行",
      "entry_price": 10.8,
      "ai_score": 85.5,
      "win_probability": 65.0,
      "reason_tags": "倍量2.5倍 + 机器人板块龙头",
      "stop_loss_price": 10.2,
      "concept_resonance": 25.5,
      "flow_ratio": 3.5,
      "launch_quality": 75.0
    }
  ],
  "count": 20,
  "diagnostic_info": {
    "total_candidates": 5000,
    "l0_pass": 1000,
    "l1_pass": 500,
    "l2_pass": 200,
    "l3_pass": 50,
    "final": 20
  },
  "metadata": {
    "market_regime": "Attack",
    "funnel_data": {
      "total": 5000,
      "L0_pass": 1000,
      "L1_pass": 500,
      "L2_pass": 200,
      "final": 20
    }
  }
}
```

#### 6.6.3 执行回测

**接口**: `POST /api/model-k/backtest`

**请求体**:
```json
{
  "start_date": "2025-01-01",
  "end_date": "2025-12-31",
  "params": {
    "min_change_pct": 2.0,
    "max_change_pct": 9.5,
    "vol_threshold": 1.5
  }
}
```

**响应**:
```json
{
  "success": true,
  "start_date": "2025-01-01",
  "end_date": "2025-12-31",
  "total_trades": 200,
  "win_rate": 0.65,
  "total_return": 0.35,
  "alpha_return": 0.20,
  "max_drawdown": -0.15,
  "sharpe_ratio": 1.5,
  "daily_returns": [
    {
      "date": "2025-01-02",
      "return": 0.02
    }
  ]
}
```

#### 6.6.4 获取推荐历史

**接口**: `GET /api/model-k/history?run_date={date}&limit={limit}&offset={offset}&model_version={version}`

**查询参数**:
- `run_date` (string, 可选): 推荐日期（YYYY-MM-DD）
- `limit` (int): 返回数量（默认100）
- `offset` (int): 偏移量（默认0）
- `model_version` (string, 可选): 模型版本（T7/T8）

**响应**:
```json
{
  "recommendations": [
    {
      "id": 1,
      "run_date": "2026-01-15",
      "sheep_code": "000001",
      "sheep_name": "平安银行",
      "entry_price": 10.8,
      "ai_score": 85.5,
      "win_probability": 65.0,
      "reason_tags": "倍量2.5倍 + 机器人板块龙头",
      "stop_loss_price": 10.2,
      "is_verified": true,
      "max_return_5d": 8.5,
      "final_return_5d": 5.2,
      "final_result": "SUCCESS",
      "strategy_version": "T7_Concept_Flow"
    }
  ],
  "count": 100
}
```

### 6.7 AI相关接口

#### 6.7.1 AI推荐肥羊

**接口**: `POST /api/ai/recommend-sheep`

**请求体**:
```json
{
  "model_name": "gpt-4",
  "custom_prompt": "请分析当前市场热点..."
}
```

**响应**:
```json
{
  "recommendation": "基于当前市场分析，推荐以下肥羊...",
  "timestamp": "2026-01-16T10:30:00",
  "cached": false
}
```

#### 6.7.2 AI分析肥羊

**接口**: `POST /api/ai/analyze-sheep/{sheep_code}`

**路径参数**:
- `sheep_code` (string): 肥羊代码

**请求体**:
```json
{
  "model_name": "gpt-4",
  "custom_prompt": "请深度分析该肥羊..."
}
```

**响应**:
```json
{
  "analysis": "该肥羊当前处于...",
  "sheep_code": "000001",
  "sheep_name": "平安银行",
  "timestamp": "2026-01-16T10:30:00",
  "cached": false
}
```

### 6.8 管理相关接口（仅管理员）

#### 6.8.1 手动触发全量数据采集

**接口**: `POST /api/admin/collect-all-data`

**响应**:
```json
{
  "message": "全量数据采集任务已启动，正在后台执行",
  "status": "running"
}
```

#### 6.8.2 检查数据缺失

**接口**: `GET /api/admin/check-data-gaps?days={days}&data_type={type}`

**查询参数**:
- `days` (int): 检查天数（默认30）
- `data_type` (string): 数据类型（sheep_daily/money_flow/hot_rank/index/all）

**响应**:
```json
{
  "message": "数据缺失检查完成",
  "days": 30,
  "data_type": "all",
  "results": {
    "sheep_daily": {
      "missing_dates": ["2026-01-10"],
      "total_dates": 30,
      "missing_count": 1
    }
  }
}
```

#### 6.8.3 获取数据类型列表

**接口**: `GET /api/admin/data-collection/types`

**响应**:
```json
{
  "types": [
    {
      "value": "sheep_daily",
      "label": "肥羊日K数据",
      "description": "肥羊日K线数据（开高低收、成交量、技术指标等）",
      "requires_trading_day": true,
      "stats": {
        "table_name": "sheep_daily",
        "schedule_time": "交易日15:00",
        "retention_days": 1095,
        "trading_days_in_period": 750,
        "actual_data_days": 745
      }
    }
  ]
}
```

### 6.8 错误响应格式

所有接口在发生错误时，统一返回以下格式：

```json
{
  "detail": "错误描述信息"
}
```

**HTTP状态码**:
- `200`: 成功
- `400`: 请求参数错误
- `401`: 未认证
- `403`: 权限不足
- `404`: 资源不存在
- `500`: 服务器内部错误
- `504`: 请求超时

---

## 7. 部署架构

### 7.1 Docker Compose部署

```
┌─────────────────────────────────────────┐
│         Nginx (前端 + 反向代理)            │
│         Port: 80                         │
└─────────────────────────────────────────┘
                  │
                  │ 反向代理
                  ▼
┌─────────────────────────────────────────┐
│         FastAPI (后端API)                │
│         Port: 8000                       │
└─────────────────────────────────────────┘
                  │
                  │ SQL
                  ▼
┌─────────────────────────────────────────┐
│         MySQL (数据库)                   │
│         Port: 3306                      │
└─────────────────────────────────────────┘
```

### 7.2 容器配置

**前端容器**:
- 基础镜像: `node:18-alpine`
- 构建: Vite构建，Nginx服务静态文件
- 端口: 80

**后端容器**:
- 基础镜像: `python:3.11-slim`
- 运行: uvicorn
- 端口: 8000

**数据库容器**:
- 基础镜像: `mysql:8.0`
- 端口: 3306
- 数据持久化: Docker Volume

### 7.3 环境变量配置

**后端环境变量** (`.env`):
```env
DB_HOST=mysql
DB_PORT=3306
DB_USER=admin
DB_PASSWORD=admin
DB_NAME=stock
JWT_SECRET_KEY=your-secret-key
```

**前端环境变量** (`.env`):
```env
VITE_API_BASE_URL=http://localhost:8000
```

### 7.4 定时任务

定时任务由APScheduler在FastAPI应用启动时自动启动，包括：
- 热度榜数据采集（每10分钟）
- 交易日数据采集（交易日15:00）
- 概念资金流实时采集（交易时间每30分钟）
- 下个交易日预测（每半小时）
- 概念板块数据采集（每天03:00）
- 概念元数据同步（每天08:00）
- 财务数据采集（每天00:00）
- 数据清理（每天04:00）

---

## 附录

### A. 数据保留策略

| 数据类型 | 保留天数 | 说明 |
|---------|---------|------|
| 肥羊日K数据 | 1095天（3年） | 用于模型回测 |
| 资金流向数据 | 1095天（3年） | 用于模型回测 |
| 板块资金流向数据 | 90天（3个月） | 实时分析 |
| 热度榜数据 | 30天 | 实时分析 |
| 财务数据 | 1825天（5年） | 基本面分析 |
| 推荐记录 | 永久 | 策略复盘 |

### B. 性能优化建议

1. **数据库索引**: 所有查询字段都已建立索引
2. **SQL层过滤**: T7模型使用SQL层过滤，减少Python层计算量
3. **缓存策略**: AI分析结果缓存3小时
4. **异步任务**: 数据采集任务使用后台异步执行
5. **连接池**: 数据库使用连接池管理连接

### C. 安全建议

1. **JWT密钥**: 生产环境必须修改JWT_SECRET_KEY
2. **数据库密码**: 使用强密码
3. **HTTPS**: 生产环境配置HTTPS
4. **API限流**: 建议添加API限流机制
5. **输入验证**: 所有用户输入都进行验证和过滤

---

**文档版本**: v1.0  
**最后更新**: 2026-01-16  
**维护者**: 系统架构组
